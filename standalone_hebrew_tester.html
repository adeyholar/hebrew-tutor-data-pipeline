<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hebrew Audio-Text Alignment Tester</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Arial Hebrew', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .book-selector {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr;
            gap: 20px;
            margin-bottom: 25px;
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }
        
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .playback-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .progress-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.1s;
            border-radius: 4px;
        }
        
        .time-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            padding: 20px 30px;
            background: #ecf0f1;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .verses-container {
            padding: 30px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .verse {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .verse:hover {
            background: #e3f2fd;
            transform: translateX(-10px);
            border-color: #3498db;
        }
        
        .verse.active {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            transform: scale(1.02) translateX(-10px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
            border-color: #2980b9;
        }
        
        .verse-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .verse-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 15px;
            font-size: 16px;
        }
        
        .verse.active .verse-number {
            background: #2c3e50;
        }
        
        .verse-timing {
            background: rgba(0,0,0,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-right: auto;
        }
        
        .verse.active .verse-timing {
            background: rgba(255,255,255,0.2);
        }
        
        .verse-text {
            font-size: 20px;
            line-height: 1.8;
            text-align: right;
        }
        
        .word {
            display: inline;
            padding: 3px 5px;
            margin: 2px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .word:hover {
            background: rgba(241, 196, 15, 0.3);
        }
        
        .word.active {
            background: #f1c40f;
            color: #2c3e50;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.6);
            transform: scale(1.1);
        }
        
        .error-message {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .loading-message {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .file-input-section {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .file-input {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        }
        
        .load-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }
        
        .load-btn:hover {
            background: #218838;
        }
        
        @media (max-width: 768px) {
            .book-selector {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .playback-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .verse-text {
                font-size: 18px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Book configurations with Hebrew names
        const books = {
            'Gen': { name: 'בראשית', chapters: 50, folder: '01_Genesis', audioCode: 'Gen' },
            'Exod': { name: 'שמות', chapters: 40, folder: '02_Exodus', audioCode: 'Exo' },
            'Lev': { name: 'ויקרא', chapters: 27, folder: '03_Leviticus', audioCode: 'Lev' },
            'Num': { name: 'במדבר', chapters: 36, folder: '04_Numbers', audioCode: 'Num' },
            'Deut': { name: 'דברים', chapters: 34, folder: '05_Deuteronomy', audioCode: 'Deut' },
            'Josh': { name: 'יהושע', chapters: 24, folder: '06_Joshua', audioCode: 'Josh' },
            'Judg': { name: 'שופטים', chapters: 21, folder: '07_Judges', audioCode: 'Judg' },
            '1Sam': { name: 'שמואל א', chapters: 31, folder: '08_1Samuel', audioCode: '1Sam' },
            '2Sam': { name: 'שמואל ב', chapters: 24, folder: '09_2Samuel', audioCode: '2Sam' },
            '1Kgs': { name: 'מלכים א', chapters: 22, folder: '10_1Kings', audioCode: '1Kgs' },
            '2Kgs': { name: 'מלכים ב', chapters: 25, folder: '11_2Kings', audioCode: '2Kgs' },
            'Isa': { name: 'ישעיהו', chapters: 66, folder: '12_Isaiah', audioCode: 'Isa' },
            'Jer': { name: 'ירמיהו', chapters: 52, folder: '13_Jeremiah', audioCode: 'Jer' },
            'Ezek': { name: 'יחזקאל', chapters: 48, folder: '14_Ezekiel', audioCode: 'Ezek' },
            'Ps': { name: 'תהלים', chapters: 150, folder: '27_Psalms', audioCode: 'Psa' },
            'Prov': { name: 'משלי', chapters: 31, folder: '29_Proverbs', audioCode: 'Prov' },
            'Job': { name: 'איוב', chapters: 42, folder: '28_Job', audioCode: 'Job' },
            'Ruth': { name: 'רות', chapters: 4, folder: '30_Ruth', audioCode: 'Ruth' },
            'Song': { name: 'שיר השירים', chapters: 8, folder: '31_SongofSongs', audioCode: 'Song' },
            'Eccl': { name: 'קהלת', chapters: 12, folder: '32_Ecclesiastes', audioCode: 'Eccles' },
            'Lam': { name: 'איכה', chapters: 5, folder: '33_Lamentations', audioCode: 'Lamen' },
            'Esth': { name: 'אסתר', chapters: 10, folder: '34_Esther', audioCode: 'Esther' },
            'Dan': { name: 'דניאל', chapters: 12, folder: '35_Daniel', audioCode: 'Daniel' },
            'Ezra': { name: 'עזרא', chapters: 10, folder: '36_Ezra', audioCode: 'Ezra' },
            'Neh': { name: 'נחמיה', chapters: 13, folder: '37_Nehemiah', audioCode: 'Nehem' },
            '1Chr': { name: 'דברי הימים א', chapters: 29, folder: '38_1Chronicles', audioCode: '1Chron' },
            '2Chr': { name: 'דברי הימים ב', chapters: 36, folder: '39_2Chronicles', audioCode: '2Chron' },
            'Obad': { name: 'עובדיה', chapters: 1, folder: '18_Obadiah', audioCode: 'Obad' }
        };

        const HebrewAlignmentTester = () => {
            const [selectedBook, setSelectedBook] = useState('Gen');
            const [selectedChapter, setSelectedChapter] = useState(1);
            const [alignmentData, setAlignmentData] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [currentVerseIndex, setCurrentVerseIndex] = useState(-1);
            const [currentWordIndex, setCurrentWordIndex] = useState(-1);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [audioFile, setAudioFile] = useState(null);
            const [jsonFile, setJsonFile] = useState(null);
            
            const audioRef = useRef(null);

            const loadFiles = async () => {
                if (!audioFile || !jsonFile) {
                    setError('אנא בחר קובץ אודיו וקובץ JSON');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Load audio
                    const audioUrl = URL.createObjectURL(audioFile);
                    if (audioRef.current) {
                        audioRef.current.src = audioUrl;
                    }

                    // Load alignment JSON
                    const alignmentText = await jsonFile.text();
                    const alignment = JSON.parse(alignmentText);
                    setAlignmentData(alignment);

                    setCurrentTime(0);
                    setCurrentVerseIndex(-1);
                    setCurrentWordIndex(-1);
                    setIsPlaying(false);

                } catch (err) {
                    setError(`שגיאה בטעינת הקבצים: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleTimeUpdate = () => {
                if (!audioRef.current || !alignmentData) return;
                
                const currentTime = audioRef.current.currentTime;
                setCurrentTime(currentTime);
                
                // Find current verse
                let newVerseIndex = -1;
                for (let i = 0; i < alignmentData.verses.length; i++) {
                    const verse = alignmentData.verses[i];
                    if (currentTime >= verse.start && currentTime <= verse.end) {
                        newVerseIndex = i;
                        break;
                    }
                }
                
                setCurrentVerseIndex(newVerseIndex);
                
                // Find current word
                if (newVerseIndex >= 0) {
                    const verse = alignmentData.verses[newVerseIndex];
                    let newWordIndex = -1;
                    if (verse.words) {
                        for (let i = 0; i < verse.words.length; i++) {
                            const word = verse.words[i];
                            if (currentTime >= word.start && currentTime <= word.end) {
                                newWordIndex = i;
                                break;
                            }
                        }
                    }
                    setCurrentWordIndex(newWordIndex);
                } else {
                    setCurrentWordIndex(-1);
                }
            };

            const handlePlay = () => {
                if (!alignmentData || !audioRef.current) {
                    setError('אנא טען קבצים תחילה');
                    return;
                }
                
                if (isPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play();
                }
                setIsPlaying(!isPlaying);
            };

            const handleReset = () => {
                if (audioRef.current) {
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
                setCurrentTime(0);
                setIsPlaying(false);
                setCurrentVerseIndex(-1);
                setCurrentWordIndex(-1);
            };

            const jumpToVerse = (verseIndex) => {
                if (!alignmentData || verseIndex >= alignmentData.verses.length || !audioRef.current) return;
                
                const verse = alignmentData.verses[verseIndex];
                audioRef.current.currentTime = verse.start;
            };

            const jumpToWord = (verseIndex, wordIndex) => {
                if (!alignmentData || !audioRef.current) return;
                
                const verse = alignmentData.verses[verseIndex];
                if (verse.words && verse.words[wordIndex]) {
                    audioRef.current.currentTime = verse.words[wordIndex].start;
                }
            };

            const handleProgressClick = (e) => {
                if (!audioRef.current || !alignmentData) return;
                
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                const newTime = percentage * alignmentData.total_duration;
                
                audioRef.current.currentTime = newTime;
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const getChapterOptions = () => {
                const book = books[selectedBook];
                return Array.from({length: book.chapters}, (_, i) => i + 1);
            };

            const getProgress = () => {
                if (!alignmentData || alignmentData.total_duration === 0) return 0;
                return (currentTime / alignmentData.total_duration) * 100;
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>🎵 בוחן יישור אודיו-טקסט עברית</h1>
                        <p>טען קבצי אודיו ו-JSON כדי לבדוק את איכות היישור</p>
                    </div>

                    <div className="controls">
                        <div className="file-input-section">
                            <h3>טעינת קבצים</h3>
                            <div>
                                <input 
                                    type="file" 
                                    accept=".mp3,.wav,.m4a" 
                                    onChange={(e) => setAudioFile(e.target.files[0])}
                                    className="file-input"
                                />
                                <label>קובץ אודיו</label>
                            </div>
                            <div>
                                <input 
                                    type="file" 
                                    accept=".json" 
                                    onChange={(e) => setJsonFile(e.target.files[0])}
                                    className="file-input"
                                />
                                <label>קובץ יישור JSON</label>
                            </div>
                            <button onClick={loadFiles} className="load-btn">
                                📂 טען קבצים
                            </button>
                        </div>

                        <div className="book-selector">
                            <div className="form-group">
                                <label>ספר:</label>
                                <select 
                                    value={selectedBook} 
                                    onChange={(e) => {
                                        setSelectedBook(e.target.value);
                                        setSelectedChapter(1);
                                    }}
                                >
                                    {Object.entries(books).map(([code, book]) => (
                                        <option key={code} value={code}>{book.name}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>פרק:</label>
                                <select 
                                    value={selectedChapter} 
                                    onChange={(e) => setSelectedChapter(parseInt(e.target.value))}
                                >
                                    {getChapterOptions().map(chapter => (
                                        <option key={chapter} value={chapter}>{chapter}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>סטטוס:</label>
                                <div style={{padding: '12px', background: '#f8f9fa', borderRadius: '8px', textAlign: 'center'}}>
                                    {loading && <span style={{color: '#f39c12'}}>🔄 טוען...</span>}
                                    {alignmentData && !loading && <span style={{color: '#27ae60'}}>✅ נטען</span>}
                                    {!alignmentData && !loading && <span style={{color: '#7f8c8d'}}>⏳ ממתין</span>}
                                </div>
                            </div>
                        </div>

                        <div className="playback-controls">
                            <button
                                onClick={handlePlay}
                                disabled={!alignmentData}
                                className="btn btn-primary"
                            >
                                {isPlaying ? '⏸️' : '▶️'} {isPlaying ? 'הפסק' : 'השמע'}
                            </button>
                            
                            <button
                                onClick={handleReset}
                                disabled={!alignmentData}
                                className="btn btn-secondary"
                            >
                                🔄 איפוס
                            </button>
                        </div>
                    </div>

                    {alignmentData && (
                        <>
                            <div className="progress-section">
                                <div className="progress-bar" onClick={handleProgressClick}>
                                    <div 
                                        className="progress-fill"
                                        style={{width: `${getProgress()}%`}}
                                    ></div>
                                </div>
                                <div className="time-info">
                                    <span>{formatTime(currentTime)}</span>
                                    <span>פסוק {currentVerseIndex >= 0 ? alignmentData.verses[currentVerseIndex].verse_number : '-'}</span>
                                    <span>{formatTime(alignmentData.total_duration)}</span>
                                </div>
                            </div>

                            <div className="stats">
                                <div className="stat-card">
                                    <div className="stat-value">{alignmentData.verse_count}</div>
                                    <div className="stat-label">פסוקים</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{formatTime(alignmentData.total_duration)}</div>
                                    <div className="stat-label">משך כולל</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{Math.round(alignmentData.overall_confidence * 100)}%</div>
                                    <div className="stat-label">ביטחון</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-value">{Math.round(getProgress())}%</div>
                                    <div className="stat-label">התקדמות</div>
                                </div>
                            </div>
                        </>
                    )}

                    {error && (
                        <div className="error-message">
                            ❌ {error}
                        </div>
                    )}

                    {loading && (
                        <div className="loading-message">
                            🔄 טוען קבצים...
                        </div>
                    )}

                    {alignmentData && (
                        <div className="verses-container">
                            {alignmentData.verses.map((verse, verseIndex) => (
                                <div
                                    key={verseIndex}
                                    className={`verse ${currentVerseIndex === verseIndex ? 'active' : ''}`}
                                    onClick={() => jumpToVerse(verseIndex)}
                                >
                                    <div className="verse-header">
                                        <div className="verse-number">{verse.verse_number}</div>
                                        <div className="verse-timing">
                                            {formatTime(verse.start)} - {formatTime(verse.end)}
                                        </div>
                                    </div>
                                    
                                    <div className="verse-text">
                                        {verse.words ? (
                                            verse.words.map((word, wordIndex) => (
                                                <span
                                                    key={wordIndex}
                                                    className={`word ${
                                                        currentVerseIndex === verseIndex && currentWordIndex === wordIndex
                                                            ? 'active' : ''
                                                    }`}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        jumpToWord(verseIndex, wordIndex);
                                                    }}
                                                    title={`${formatTime(word.start)} - ${formatTime(word.end)}`}
                                                >
                                                    {word.word}
                                                </span>
                                            ))
                                        ) : (
                                            <span>{verse.text}</span>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <audio
                        ref={audioRef}
                        onTimeUpdate={handleTimeUpdate}
                        onLoadedMetadata={() => setDuration(audioRef.current.duration)}
                        onEnded={() => setIsPlaying(false)}
                        onPlay={() => setIsPlaying(true)}
                        onPause={() => setIsPlaying(false)}
                        style={{display: 'none'}}
                    />
                </div>
            );
        };

        ReactDOM.render(<HebrewAlignmentTester />, document.getElementById('root'));
    </script>
</body>
</html>